# MCP Coop Chain

**MCP Coop Chain** — модульный блокчейн-фреймворк для кооперативных сетей, реализующий прозрачную обработку транзакций, кошельков, контрактов и снапшотов состояния. Проект построен по принципам SOLID и clean-архитектуры, легко расширяется и покрыт тестами.

---

## 1. Описание проекта

MCP Coop Chain реализует:
- Децентрализованную цепочку блоков с поддержкой Proto API-контрактов.
- Безопасные кошельки на ECDSA с адресами, производными от публичного ключа.
- Систему транзакций с комиссиями, защитой от дубликатов и replay-атак.
- Централизованный mempool с лимитами и автоматическим созданием блоков.
- Снапшоты состояния для быстрого восстановления и отказоустойчивости.
- Гибкую конфигурацию всех параметров через JSON-файл.
- Полноценный CLI-интерфейс для управления блокчейном.

---

## 2. Архитектурный обзор

**Структура директорий:**

- [`internal/blockchain/`](internal/blockchain/) — ядро блокчейна: блоки, mempool, валидация, FullNode, обработка транзакций, таймеры.
- [`internal/wallet/`](internal/wallet/) — логика кошельков: генерация, подпись, валидация адреса, шифрование приватных ключей.
- [`internal/contracts/proto/`](internal/contracts/proto/) — Proto API: встроенные контракты (Transfer, GetBalance, CreateWallet и др.), их реестр и вызовы.
- [`internal/storage/`](internal/storage/) — работа с файлами снапшотов, восстановление состояния, mock- и memory-хранилище.
- [`internal/types/`](internal/types/) — все основные типы: Block, Transaction, Wallet, BlockchainConfig, Snapshot и др.
- [`cmd/cli/`](cmd/cli/) — точка входа для CLI-интерфейса (см. [`cli.go`](cmd/cli/cli.go)).
- [`configs/`](configs/) — конфигурационные файлы (например, `blockchain_config.json`).
- [`data/`](data/) — снапшоты состояния (`full_state_snapshot.json`).
- [`logs/`](logs/) — логи работы узла.

---

## 3. Как работает FullNode

- **FullNode** управляет цепочкой блоков, mempool, кошельками и снапшотами.
- Блоки создаются автоматически по таймеру (параметр `blockTimeSeconds`) или досрочно при переполнении mempool.
- Все транзакции проходят полную валидацию (подпись, баланс, комиссия, дубликаты) до попадания в mempool.
- При создании блока транзакции сортируются по комиссии, валидируются повторно, формируется MerkleRoot.
- После добавления блока mempool очищается, состояние сериализуется в снапшот.

---

## 4. Кошельки и транзакции

- Кошельки создаются через ECDSA (P-256), адрес = SHA256(publicKey) в base58.
- Приватные ключи шифруются AES-GCM с PBKDF2.
- Подпись транзакции проверяется до попадания в mempool и при обработке блока.
- Баланс не может быть отрицательным, комиссия всегда списывается.
- Структура [`Transaction`](internal/types/transaction.go): sender, receiver, payload, комиссия, подпись, timestamp, nonce.

---

## 5. Proto API-контракты

- Все бизнес-операции (Transfer, GetBalance, CreateWallet, AddSmartContract) реализованы как встроенные Proto API-контракты.
- Контракты регистрируются через [`protoRegistry`](internal/contracts/proto/proto_registry.go), вызываются централизованно.
- Прямой доступ к логике вне Proto API невозможен — все действия CLI/REST должны идти через Proto API.
- Контракты валидируются перед исполнением, ошибки логируются.

---

## 6. Система снапшотов

- Всё состояние сети (блоки, mempool, кошельки, контракты, state) сериализуется в [`full_state_snapshot.json`](data/full_state_snapshot.json).
- При запуске FullNode состояние восстанавливается из снапшота, история не теряется.
- Структура снапшота: см. [`FullChainSnapshot`](internal/types/snapshot.go).

---

## 7. Запуск проекта и FullNode

1. Установите Go >= 1.19
2. Склонируйте репозиторий и перейдите в директорию проекта
3. Проверьте/отредактируйте [`configs/blockchain_config.json`](configs/blockchain_config.json) под свои параметры
4. Запустите FullNode:
   ```bash
   go run ./cmd/mcpchain/main.go
   ```
5. Логи работы будут в [`logs/`](logs/) и консоли

---

## 8. CLI-интерфейс MCP Coop Chain

CLI реализован в [`cmd/cli/cli.go`](cmd/cli/cli.go) и поддерживает все основные команды управления блокчейном. Для запуска CLI используйте:

```bash
go run ./cmd/cli/cli.go <команда> [аргументы]
```

### Доступные команды:

- `init` — инициализация блокчейна, создание Genesis-блока
- `start` — запуск FullNode (автоматическое создание блоков, mempool)
- `stop` — корректная остановка узла, сохранение состояния
- `addwallet` — создание нового кошелька
- `tx <from> <to> <amount>` — создание, подписание и отправка транзакции
- `deploy <name> <body>` — деплой нового смарт-контракта (Proto API)
- `exec <name> [params...]` — вызов смарт-контракта (Proto API)

### Примеры использования:

```bash
# Инициализация блокчейна
go run ./cmd/cli/cli.go init

# Запуск FullNode
go run ./cmd/cli/cli.go start

# Создание кошелька
go run ./cmd/cli/cli.go addwallet

# Отправка транзакции
# (from/to — адреса, amount — целое число в микро-MCP)
go run ./cmd/cli/cli.go tx <from> <to> <amount>

# Деплой смарт-контракта
go run ./cmd/cli/cli.go deploy MyContract 'contract code here'

# Вызов смарт-контракта
go run ./cmd/cli/cli.go exec MyContract param1 param2
```

- Все команды CLI реализованы как thin wrapper, не содержат бизнес-логики, вызывают соответствующие модули ядра.
- Все параметры берутся из конфига, нет хардкода.
- Ошибки и статусы выводятся в консоль.
- Код CLI покрыт GoDoc-комментариями и легко расширяется.

---

## 9. REST API и сеть

- Архитектура позволяет реализовать REST API и P2P без изменения ядра (см. интерфейсы в [`internal/types/`](internal/types/)).
- Параметры REST и P2P настраиваются через конфиг (`rest`, `p2p` секции).
- Все внешние интерфейсы должны использовать Proto API для взаимодействия с ядром.

---

## 10. Конфигурирование через `blockchain_config.json`

Все параметры блокчейна управляются через [`configs/blockchain_config.json`](configs/blockchain_config.json) и отражены в [`internal/types/blockchain_config.go`](internal/types/blockchain_config.go):
- Название и символ токена
- Стартовая эмиссия
- Тайминги блоков, лимиты mempool, размер блока
- Комиссии (TxFee, PriorityTxFee, CallProtoAPIMethodFee и др.)
- Параметры консенсуса, рейтинга валидаторов, стейкинга, ликвидности
- Список встроенных контрактов, лимиты по gas/calls
- Параметры REST API и P2P
- Путь к файлу снапшота

---

## 11. SOLID и clean-архитектура

- Все модули слабо связаны, используют интерфейсы и DI.
- Типы и бизнес-логика разделены по слоям.
- Нет хардкода параметров — всё управляется через конфиг.
- Проект покрыт тестами (`*_test.go`), поведение функций прозрачно и предсказуемо.

---

## 12. Контрибьюторам

- Перед добавлением новых функций — проверьте, что они не нарушают архитектуру и SOLID.
- Все новые параметры должны быть вынесены в конфиг.
- Покрывайте изменения тестами и обновляйте документацию.

---

**MCP Coop Chain — современный, прозрачный и расширяемый блокчейн для кооперативных сетей!** 